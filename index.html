<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>socket chat</title>
    <style>
dl#log{
	margin:0;
}
#log dt.syslog{
	color:#0000ff !important;
}
#log dd span.info{
	font-size:smaller;
	color:#cccccc;
}
#log dt{
	display:inline;
}
#log dt:after{
	content:'>';
}
#log dt ~ dt:before{
	content:"\a";
	white-space:pre;
}
#log dd{
	display:inline;
	margin-left:0;
}
div#info{
	position:fixed;
	right:0px;
	bottom:0px;
	opacity:0.45;
	text-align:right;
}
ul.users{
	margin:0;
}
ul.users li{
	list-style:none;
}
ul.users li span{
	background-color:#dddddd;
}
span.s{
	text-decoration:line-through;
}
span.small{
	font-size:smaller;
}
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    
function LineMaker(){
}
LineMaker.prototype={
	make:function(obj){
		var df=document.createDocumentFragment();
		var color=this.getColor(obj.ip);
		var dt=el("dt",obj.name);
		if(obj.syslog)dt.classList.add("syslog");
		dt.style.color=color;
		
		df.appendChild(dt);
		var dd=el("dd","");
		var comsp=el("span",obj.comment);
		comsp.classList.add("comment");
		dd.appendChild(comsp);
		var infsp=el("span","(");
		infsp.classList.add("info");
		var date=new Date(obj.time);
		var time=el("time",date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds());
		time.datetime=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+"T"+date.getHours()+":"+date.getMinutes()+":"+date.getSeconds()+"+09:00";
	
		infsp.appendChild(time);
		infsp.appendChild(document.createTextNode(", "+obj.ip+")"));
		dd.appendChild(infsp);
		dd.style.color=color;
		df.appendChild(dd);
		return df;

		function el(name,text){
			var ret=document.createElement(name);
			ret.textContent=text;
			return ret;
		}
	},
	getColor:function(ip){
		var arr=ip.split(/\./);
		return "rgb("+Math.floor(parseInt(arr[0])*0.75)+", "+
		Math.floor(parseInt(arr[1])*0.75)+", "+
		Math.floor(parseInt(arr[2])*0.75)+")";
	},
}


function HighChatMaker(){
}
HighChatMaker.prototype=new LineMaker();
HighChatMaker.prototype.make=function(obj){
	var df=LineMaker.prototype.make.apply(this,arguments);
	
	var dd=df.childNodes.item(1);
	parse(dd);
	return df;
	
	function parse(node){
		if(node.nodeType==Node.TEXT_NODE){
			//テキストノード
			var v=node.nodeValue;
			var result;
			//[s]の解析
			result=v.match(/^(.*)\[s\](.*?)(\[\/s\].*)?$/);
			if(result){
				var dff=document.createDocumentFragment();
				if(result[1]){
					dff.appendChild(document.createTextNode(result[1]));
				}
				if(result[2]){
					var span=document.createElement("span");
					span.textContent=result[2];
					span.classList.add("s");
					dff.appendChild(span);
				}
				if(result[3]){
					dff.appendChild(document.createTextNode(result[3].slice(4)));
				}
				parse(dff);
				node.parentNode.replaceChild(dff,node);
				return;
			}
			//[small]の解析
			result=v.match(/^(.+)?\[small\](.*?)(\[\/small\].*)?$/);
			if(result){
				var dff=document.createDocumentFragment();
				if(result[1]){
					dff.appendChild(document.createTextNode(result[1]));
				}
				if(result[2]){
					var span=document.createElement("span");
					span.textContent=result[2];
					span.classList.add("small");
					dff.appendChild(span);
				}
				if(result[3]){
					dff.appendChild(document.createTextNode(result[3].slice(8)));
				}				parse(dff);
				node.parentNode.replaceChild(dff,node);
				return;
			}
			//URLの解析
			if(!node.parentNode || node.parentNode.nodeName.toLowerCase()!="a"){
				result=v.match(/^(.*?)(https?:\/\/\S+)(.*)$/);
				if(result){
					var dff=document.createDocumentFragment();
					if(result[1]){
						dff.appendChild(document.createTextNode(result[1]));
					}
					if(result[2]){
						var a=document.createElement("a");
						a.target="_blank";
						a.href=result[2];
						a.textContent=result[2];
						dff.appendChild(a);
					}
					if(result[3]){
						dff.appendChild(document.createTextNode(result[3]));
					}
					parse(dff);
					node.parentNode.replaceChild(dff,node);
					return;
				}
				
				if(result=v.match(/^(.*)#(\d{4})(.*)$/)){
					var dff=document.createDocumentFragment();
					if(result[1]){
						dff.appendChild(document.createTextNode(result[1]));
					}
					if(result[2]){
						var a=document.createElement("a");
						a.target="_blank";
						a.href="http://81.la/"+result[2];
						a.textContent="#"+result[2];
						dff.appendChild(a);
					}
					if(result[3]){
						dff.appendChild(document.createTextNode(result[3]));
					}
					parse(dff);
					node.parentNode.replaceChild(dff,node);
					return;
				}
				
			}
		}else if(node.childNodes){
			var nodes=[];
			for(var i=0,l=node.childNodes.length;i<l;i++){
				nodes.push(node.childNodes[i]);
			}
			nodes.forEach(function(x){
				if(x.parentNode.isSameNode(node))
					parse(x);
			});
		}
	}
};

    </script>
    <script>
function SocketChat(log,info){
	this.logid=log,this.infoid=info;
	this.line=new HighChatMaker();
}
SocketChat.prototype={
	init:function(){
		this.log=document.getElementById(this.logid);
		this.info=document.getElementById(this.infoid);
		this.users=this.info.getElementsByClassName("users")[0];
		this.usernumber=this.info.getElementsByClassName("usernumber")[0];
		
		var socket;
		socket=this.socket = io.connect(location.origin);
		
		socket.on("init",this.loginit.bind(this));
		socket.on("log",this.write.bind(this));
		socket.on("users",this.userlist.bind(this));
		socket.on("userinfo",this.userinfo.bind(this));
		
		/*document.forms["inout"].addEventListener("submit",this.submit.bind(this),false);
		document.forms["comment"].addEventListener("submit",this.submit.bind(this),false);*/
		document.addEventListener("submit",this.submit.bind(this),false);
		
		if(localStorage.socketchat_name){
			document.forms["inout"].elements["uname"].value=localStorage.socketchat_name;
		}
	},
	loginit:function(data){
			
		data.logs.forEach(function(line){
			this.write(line);
		},this);
	},
	write:function(obj){
		
		this.log.insertBefore(this.line.make(obj),this.log.firstChild);
		
		
	},
	userlist:function(obj){
		while(this.users.firstChild)this.users.removeChild(this.users.firstChild);
		
		var active=0;
		obj.users.forEach(function(user){
			if(user.rom)return;
			var li=document.createElement("li");
			var sp=document.createElement("span");
			sp.textContent=user.name;
			
			sp.title=user.ip+" / "+user.ua;
			
			li.appendChild(sp);
			this.users.appendChild(li);
			active++;
		},this);
		this.usernumber.textContent=active+"人"+(obj.roms? "（ROM"+obj.roms+")":"");

	},
	userinfo:function(obj){
		var f=document.forms["inout"];
		f.elements["uname"].disabled=!obj.rom;
		
		var result=document.evaluate('descendant::input[@type="submit"]',f,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null);
		var bt=result.singleNodeValue;
		bt.value=obj.rom?"入室":"退室";
		
	},
	submit:function(e){
		var f=e.target;
		if(f.name=="inout"){
			//入退室
			var el=f.elements["uname"];
			this.socket.emit("inout",{"name":el.value});
			
			localStorage.socketchat_name=el.value;
		}else if(f.name=="comment"){
			//発言
			var el=f.elements["comment"];
			this.socket.emit("say",{"comment":el.value});
			el.value="";
		}
		e.preventDefault();
	},
	
};
    </script>
    <script>
Chat=new SocketChat("log","info");
window.addEventListener('load',function(){
	Chat.init();
},false);
    </script>
  </head>
  <body>
  <form name="inout">
    <p><input name="uname" size="30" maxlength="25" required><input type="submit" value="入室"></p>
  </form>
  <form name="comment">
    <p><input name="comment" size="80" maxlength="200" required><input type="submit" value="発言"></p>
  <dl id="log">
  </dl>
  <div id="info">
    <span class="usernumber"></span>
    <ul class="users">
    </ul>
  </div>
  </body>
</html>
